/* alv-ch-ng - 0.2.0 - 2015-01-13 - Copyright (c) 2015 Informatik der Arbeitslosenversicherung; */
!function(){"use strict";function a(a,b,c,e,f){if(e){var g=e.replace(d,"").split(",");c(g)||b.addClass("ng-hide"),f.$on(a.getConstants().EVENT_NAME_LOGOUT,function(){c(g)?b.removeClass("ng-hide"):b.addClass("ng-hide")}),f.$on(a.getConstants().EVENT_NAME_LOGIN_CONFIRMED,function(){c(g)&&b.removeClass("ng-hide")})}}function b(a,b,c,d){a.isAuthenticated()?d?c.addClass("ng-hide"):c.removeClass("ng-hide"):d?c.removeClass("ng-hide"):c.addClass("ng-hide"),b.$on(a.getConstants().EVENT_NAME_LOGIN_CONFIRMED,function(){d?c.addClass("ng-hide"):c.removeClass("ng-hide")}),b.$on(a.getConstants().EVENT_NAME_LOGOUT,function(){d?c.removeClass("ng-hide"):c.addClass("ng-hide")})}var c=angular.module("alv-ch-ng.security",["alv-ch-ng.ui-forms"]);c.provider("AuthenticationService",function(a){function b(){return n}function c(a){if(!a)throw new Error("constants must not be empty.");jQuery.extend(!0,n,a)}function d(a){if(!a)throw new Error("authenticatorName must not be empty.");if(!p[a])throw new Error("No authenticator with name '"+a+"' registered.");t=a}function e(a,b){if(!a)throw new Error("name must not be empty.");if(a===m)throw new Error("name must not be equal to '"+m+"'.");if(!b)throw new Error("authenticator must not be empty.");if(!angular.isFunction(b.authenticate))throw new Error("authenticator.authenticate must be a function.");p[a]=b}function f(){return p[t]}function g(){return q[t]}function h(a,b){if(!a)throw new Error("name must not be empty.");if(!p[a])throw new Error("Could not configure unknown authenticator '"+a+"'.");if(!b)throw new Error("config must not be empty.");q[a]=b}function i(a,b){return f().authenticate(a,b,g(),s)}function j(){return s.user}function k(){return j()?!0:!1}function l(){return s.user=null,s.$broadcast(n.EVENT_NAME_LOGOUT),!0}var m="defaultAuthenticator",n={EVENT_NAME_LOGIN:"sec:login",EVENT_NAME_LOGIN_REQUIRED:"sec:loginRequired",EVENT_NAME_LOGIN_FAILED:"sec:loginFailed",EVENT_NAME_LOGIN_REQUEST:"sec:loginRequest",EVENT_NAME_LOGIN_CONFIRMED:"sec:loginConfirmed",EVENT_NAME_2FA_REQUIRED:"sec:2faRequired",EVENT_NAME_2FA_FAILED:"sec:2faFailed",EVENT_NAME_LOGOUT:"sec:logout"},o=a.defaults.headers,p={};p[m]={authenticate:function(a,b,c,d){o.common.Authorization="Basic "+r.encode(a+":"+b),u.get(v).success(function(a){d.user=a,d.$broadcast(d.user.authToken?n.EVENT_NAME_2FA_REQUIRED:n.EVENT_NAME_LOGIN_CONFIRMED)}).error(function(){d.user=null,d.$broadcast(n.EVENT_NAME_LOGIN_FAILED)})}};var q={};q[m]={endpoint:"/api/currentUser"};var r,s,t=m,u={},v="/api/currentUser";return{$get:function(a,c,d){return s=a,r=d,u=c,{getConstants:b,login:i,getCurrentUser:j,isAuthenticated:k,logout:l}},setConstants:c,setAuthenticatorName:d,addAuthenticator:e,setAuthenticatorOptionsFor:h}}),c.factory("SecurityService",function(a,b,c){function d(a,b){return c.isAuthenticated()?void 0:c.login(a,b)}function e(){return c.isAuthenticated()?c.logout():!1}function f(b){var c=a.user;if(!b)return!0;var d=!0;if(0===b.trim().indexOf("!")&&(d=!d,b=b.replace("!","")),c&&c.roles)for(var e=0;e<c.roles.length;e++)if(c.roles[e].key.trim().toLowerCase()===b.trim().toLowerCase())return d;return!d}function g(a){if(!a||0===a.length)return!0;for(var b=0;b<a.length;b++)if(f(a[b]))return!0;return!1}function h(a){if(!a)return!0;for(var b=0;b<a.length;b++)if(!f(a[b]))return!1;return!0}function i(b){if(!b)return!0;var c=a.user,d=!0;if(0===b.trim().indexOf("!")&&(d=!d,b=b.replace("!","")),c&&c.groups)for(var e=0;e<c.groups.length;e++)if(c.groups[e].trim().toLowerCase()===b.trim().toLowerCase())return d;return!d}function j(a){if(!a)return!0;for(var b=0;b<a.length;b++)if(i(a[b]))return!0;return!1}function k(a){if(!a)return!0;for(var b=0;b<a.length;b++)if(!i(a[b]))return!1;return!0}return{login:d,logout:e,isAuthenticated:c.isAuthenticated,hasRole:f,hasAnyRole:g,hasAllRoles:h,hasGroup:i,hasAnyGroup:j,hasAllGroups:k,getConstants:c.getConstants,getCurrentUser:c.getCurrentUser}});var d=new RegExp('"|\\[|]',"g");c.directive("hasRole",["$rootScope","SecurityService",function(b,c){return{restrict:"A",replace:!1,priority:50,link:function(d,e,f){a(c,e,c.hasAnyRole,f.hasRole,b)}}}]),c.directive("auth",["$rootScope","SecurityService",function(a,c){return{restrict:"A",replace:!1,priority:50,link:function(d,e){b(c,a,e)}}}]),c.directive("notAuth",["$rootScope","SecurityService",function(a,c){return{restrict:"A",replace:!1,priority:50,link:function(d,e){b(c,a,e,!0)}}}]),c.directive("formLogin",["SecurityService","AuthenticationService",function(a,b){return{restrict:"EA",replace:!0,templateUrl:"template/security/form-login.html",priority:50,link:function(c){c.login=function(){a.login(c.loginUsr,c.loginPwd)},c.$on(b.getConstants().EVENT_NAME_2FA_REQUIRED,function(){c.authTokenShow=!0})}}}]),c.directive("formLoginMessage",["$compile","AuthenticationService",function(a,b){return{restrict:"EA",replace:!0,templateUrl:"template/security/form-login-message.html",priority:50,link:function(a){a.formLoginMessage={},a.formLoginMessage.display=!1,a.formLoginMessage.severity="info",a.formLoginMessage.messageTitle="",a.formLoginMessage.messageContent="",a.$on(b.getConstants().EVENT_NAME_LOGIN_CONFIRMED,function(){a.formLoginMessage.display=!0,a.formLoginMessage.severity="success",a.formLoginMessage.messageTitle="Login",a.formLoginMessage.messageContent="Login successful."}),a.$on(b.getConstants().EVENT_NAME_LOGIN_FAILED,function(){a.formLoginMessage.display=!0,a.formLoginMessage.severity="danger",a.formLoginMessage.messageTitle="Login",a.formLoginMessage.messageContent="Username and/or password are wrong."}),a.$on(b.getConstants().EVENT_NAME_2FA_REQUIRED,function(){a.formLoginMessage.display=!0,a.formLoginMessage.messageTitle="2FA Authentication",a.formLoginMessage.messageContent="2FA Verification required."}),a.$on(b.getConstants().EVENT_NAME_2FA_FAILED,function(){a.formLoginMessage.display=!0,a.formLoginMessage.severity="danger",a.formLoginMessage.messageTitle="2FA Authentication",a.formLoginMessage.messageContent="2FA Verification failed."})}}}]),c.service("Base64Service",function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(b){for(var c,d,e,f,g,h="",i="",j="",k=0;k<b.length;)c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";return h},this.decode=function(b){var c,d,e,f,g,h="",i="",j="",k=0;for(b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");k<b.length;)e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!==g&&(h+=String.fromCharCode(d)),64!==j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";return h}})}(),angular.module("alv-ch-ng.security").run(["$templateCache",function(a){"use strict";a.put("template/security/form-login-message.html",'<div class="alert alert-{{formLoginMessage.severity}} alert-dismissable">\n    <span><strong>{{formLoginMessage.messageTitle}}</strong>&nbsp;{{formLoginMessage.messageContent}}</span>\n    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>\n</div>'),a.put("template/security/form-login.html",'<form not-auth>\n    <input form-input form-label="loginUser" type="email" id="loginUser" ng-model="loginUser" />\n    <input form-input form-label="loginPwd" type="password" id="loginPwd" ng-model="loginPwd" />\n    <input form-input form-label="loginAuthToken" form-prepend="Authy" type="number" id="authToken" ng-model="authToken" ng-show="authTokenShow" />\n    <button class="btn-primary" ng-click="login()" ng-show="!authTokenShow">Login</button>\n    <button class="btn-primary" ng-click="authenticate()" glyph-icon="eye-open" ng-show="authTokenShow">Authenticate</button>\n</form>')}]);